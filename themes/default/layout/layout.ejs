<!DOCTYPE html>
<html lang="<%= page.lang %>">
<%- partial('_partial/head') %>
<body class="mdui-appbar-with-toolbar mdui-theme-primary-<%= theme.theme_color.primary || 'indigo' %> mdui-theme-accent-<%= theme.theme_color.accent || 'pink' %>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // 模拟页面刷新时的各种事件
    function simulatePageRefresh() {
      // 滚动到顶部
      window.scrollTo(0, 0);
      
      // 触发常见的文档事件
      document.dispatchEvent(new Event('DOMContentLoaded'));
      document.dispatchEvent(new Event('readystatechange'));
      
      // 触发窗口事件
      window.dispatchEvent(new Event('load'));
      window.dispatchEvent(new Event('scroll'));
      window.dispatchEvent(new Event('resize'));
      window.dispatchEvent(new Event('orientationchange'));

      // 触发焦点相关事件
      window.dispatchEvent(new Event('focus'));
      document.hasFocus() && document.activeElement && document.activeElement.focus();

        try {
        const drawer = document.querySelector('.mdui-drawer');
        if (drawer) {
          const $ = mdui.$;
          const inst = new mdui.Drawer(drawer);
          
          // 检查是否为移动设备
          const isMobile = window.innerWidth < 1024; // mdui 默认断点
          
          // 检查本地存储中的状态
          const isForceClose = localStorage.getItem('mdui-drawer-close');
          
          if (isMobile || isForceClose) {
            // 移除所有遮罩
             $('.mdui-overlay').remove();
            // 关闭抽屉
            inst.close(true); // true 表示不显示遮罩
            // 确保移除drawer-open类
            //$('body').removeClass('mdui-drawer-body-left mdui-drawer-open');
            $('body').css('overflow', 'auto');

          }
        }
      } catch (err) {
        console.warn('处理抽屉导航失败:', err);
        alert('处理抽屉导航失败，请刷新页面');
      }
      
      // 触发自定义事件用于其他脚本
      window.dispatchEvent(new Event('page:updated'));
      // 确保 initNoticeSystem 被正确调用
      if (typeof window.initNoticeSystem === 'function') {
        window.initNoticeSystem();
      }
        // 重置通知系统状态
      
  // 重置通知系统状态
      if (localStorage.getItem('notice-system-initialized') === 'true') {
        const noticeElement = document.getElementById('random-notice');
        if (noticeElement && 
            (window.location.pathname === '/' || 
            window.location.pathname === '/index.html')) {
          console.log('Reinitializing notice system');
          window.initNoticeSystem();
        }
      }
    
    // 在首页时重新初始化通知系统
    if (window.location.pathname === '/' || 
        window.location.pathname === '/index.html') {
      if (typeof window.initNoticeSystem === 'function') {
        window.initNoticeSystem();
      }
    }
      console.log('Page type:', window.location.pathname);
      console.log('Notice system status:', window.noticeSystemInitialized);
    }
    
    // 显示加载进度条
    function showLoading() {
      // 创建线性进度条
      let progressBar = document.querySelector('.loading-progress');
      if (!progressBar) {
      progressBar = document.createElement('div');
      progressBar.className = 'mdui-progress loading-progress';
      const inner = document.createElement('div'); 
      inner.className = 'mdui-progress-indeterminate';
      progressBar.appendChild(inner);
      // 插入到body顶部
      document.body.insertBefore(progressBar, document.body.firstChild);
      }
      progressBar.style.display = 'block';
    }
    
    // 隐藏加载进度条
    function hideLoading() {
      const progressBar = document.querySelector('.loading-progress');
      if (progressBar) {
      progressBar.style.display = 'none';
      }
    }
    
    // 拦截所有站内链接的点击
    $(document).on('click', 'a', function(e) {
      const link = $(this);
      const href = link.attr('href');
      console.log('点击链接href:', href);
      console.log('点击事件e:', e);
      console.log('链接元素link:', link);


      // 跳过空链接、javascript: 协议和纯hash链接
      if (link.find('.mdui-icon.material-icons').text() === 'search' || !href || typeof href !== 'string' || href.startsWith('javascript:') || href.startsWith('#')) {
        console.log('跳过链接:', href);
        return;
      }
      
      // 检查是否是站内链接，且不需要在新标签页打开
      if (link.prop('host') === window.location.host && 
          !link.attr('target') && 
          link.attr('target') !== '_blank' &&
          !e.ctrlKey && 
          !e.shiftKey && 
          !e.metaKey) {
          console.log('开始SPA处理:', href);
        
        e.preventDefault();
        showLoading();
        
        $.ajax({
          url: link.attr('href'),
          method: 'GET',
          dataType: 'html',
          success: function(response) {
            try {
              const $response = $(response);
              const $newContent = $response.find('#main');
              const $mainContent = $newContent.length ? $newContent : $response.filter('#main');
              
              if(!$mainContent.length) {
                console.error('无法找到内容区域，响应内容:', response);
                throw new Error('无法找到目标内容');
              }
              
              $('#main').html($mainContent.html());
              history.pushState({}, '', link.attr('href'));
              document.title = $response.filter('title').text() || document.title;
              
              simulatePageRefresh();
              hideLoading();
            } catch(err) {
              console.error('页面切换失败:', err);
              mdui.snackbar({
                message: '页面切换失败，(switch_error)',
                timeout: 1500,
                onClose: function() {
                  window.location.href = link.attr('href');
                }
              });
            }
          },
          error: function(xhr, status, error) {
            console.error('页面加载失败:', error);
            mdui.snackbar({
              message: '页面加载失败，(ajax_error)',
              timeout: 1500,
              onClose: function() {
                window.location.href = link.attr('href');
              }
            });
          }
        });
      }
    });

    // 处理浏览器前进/后退
    window.onpopstate = function() {
      showLoading();
      
      const link = $(location);
      const href = location.href;

      // 跳过空链接、javascript: 协议和纯hash链接
      if (link.find('.mdui-icon.material-icons').text() === 'search' || !href || typeof href !== 'string' || href.startsWith('javascript:') || href.startsWith('#')) {
        console.log('跳过链接:', href);
        return;
      }
      
      $.ajax({
        url: location.href,
        method: 'GET',
        dataType: 'html',
        success: function(response) {
          try {
            const $response = $(response);
            const $newContent = $response.find('#main');
            const $mainContent = $newContent.length ? $newContent : $response.filter('#main');
            
            if(!$mainContent.length) {
              console.error('无法找到内容区域，响应内容:', response);
              throw new Error('无法找到目标内容');
            }
            
            $('#main').html($mainContent.html());
            document.title = $response.filter('title').text() || document.title;
            
            simulatePageRefresh();
            hideLoading();
          } catch(err) {
            console.error('页面切换失败:', err);
            mdui.snackbar({
              message: '页面切换失败，(br_switch_error)',
              timeout: 1500,
              onClose: function() {
                window.location.href = link.attr('href');
              }
            });
          }
        },
        error: function(xhr, status, error) {
          console.error('页面加载失败:', error);
          mdui.snackbar({
            message: '页面加载失败，(br_ajax_error)',
            timeout: 1500,
            onClose: function() {
              window.location.reload();
            }
          });
        }
      });
    };
  </script>
  <script>if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <script>var a=localStorage.getItem("mdui-drawer-close");if(!a){document.getElementsByTagName("body")[0].className+=" mdui-drawer-body-left"};</script>
  <%- partial('_partial/header', null, {cache: !config.relative_link}) %>
  <%- partial('_partial/sidebar', null, {cache: !config.relative_link}) %>
  <main id="main" class="mdui-m-t-5 fadeIn animated"><%- body %></main>
  <%- partial('_partial/footer', null, {cache: !config.relative_link}) %>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons" translate="no">arrow_upward</i></button>
  <% if (theme.busuanzi.site || theme.busuanzi.page) { %><script defer src="<%- theme.busuanzi.busuanzi_js %>"></script><% } %>
  <%- js(['js/mdui', 'js/script']) %>
  <%- js('custom') %>
</body>
</html>